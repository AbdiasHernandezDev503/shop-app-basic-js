<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resultados de búsqueda</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  </head>

  <body class="bg-[#F4EDE6]">
    <!-- NAV -->
    <nav
      class="w-full flex items-center justify-between px-6 py-4 bg-[#F7F2EB] shadow"
    >
      <!-- LOGO + BOTÓN VOLVER -->
      <div class="flex items-center gap-3">
        <a href="./inicio.html">
          <i class="fa-solid fa-arrow-left text-xl cursor-pointer"></i>
        </a>

        <img src="../images/logo.png" class="w-9" />
        <span class="font-bold text-[#C5573E] text-xl">EL FARO DEL LIBRO</span>
      </div>

      <!-- Buscador -->
      <div class="relative w-1/3">
        <input
          id="searchInput"
          type="text"
          placeholder="Hinted search text"
          class="w-full border border-gray-300 rounded-full py-2 px-4 pl-5 shadow text-sm outline-none"
          onkeypress="handleSearch(event)"
        />

        <i
          class="fa-solid fa-magnifying-glass absolute right-4 top-3 text-gray-500"
        ></i>
      </div>

      <!-- Usuario -->
      <div class="flex items-center gap-6">
        <div
          class="flex items-center gap-2 cursor-pointer"
          onclick="window.location.href='./mi-cuenta.html'"
        >
          <i class="fa-regular fa-user text-xl"></i>
          <span id="userName" class="font-medium">Paola</span>
        </div>
        <i
          class="fa-solid fa-cart-shopping cursor-pointer text-xl"
          onclick="openModal()"
        ></i>

        <span class="font-semibold">$120.5</span>
      </div>
    </nav>

    <!-- CONTENIDO -->
    <div class="px-12 mt-10">
      <!-- TÍTULO DE RESULTADOS -->
      <h2 id="resultsTitle" class="text-3xl font-semibold"></h2>
      <p id="resultCount" class="text-gray-600 mt-2"></p>

      <!-- GRID -->
      <div
        id="resultGrid"
        class="w-full flex flex-wrap gap-8 justify-start mt-10 pb-20"
      ></div>
    </div>

    <!-- MODAL DE DETALLES -->
    <div
      id="detailModalOverlay"
      class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
    >
      <div id="detailModalContent"></div>
    </div>

    <script type="module" src="../js/search.js"></script>
    <script type="module" src="../js/main.js"></script>

    <script type="module">
      import { db } from "../js/firebase-loader.js";
      import {
        ref,
        get,
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const categoria = params.get("categoria");
        const query = params.get("query");

        if (categoria) {
          cargarPorCategoria(categoria);
        } else if (query) {
          cargarPorTexto(query);
        }
      });

      // -------- FUNCIÓN QUE TE PASÉ --------
      async function cargarPorCategoria(categoria) {
        const librosRef = ref(db, "libros");
        const snapshot = await get(librosRef);

        if (!snapshot.exists()) return;

        const libros = Object.values(snapshot.val());
        const resultados = libros.filter(
          (l) => l.categoria?.toLowerCase() === categoria.toLowerCase()
        );

        renderResultados(resultados, `Categoría: ${categoria}`);
      }

      // Función opcional para búsquedas por texto
      async function cargarPorTexto(texto) {
        const librosRef = ref(db, "libros");
        const snapshot = await get(librosRef);

        if (!snapshot.exists()) return;

        const libros = Object.values(snapshot.val());
        const q = texto.toLowerCase();

        const resultados = libros.filter(
          (l) =>
            l.titulo.toLowerCase().includes(q) ||
            l.autor.toLowerCase().includes(q) ||
            l.categoria.toLowerCase().includes(q)
        );

        renderResultados(resultados, `Resultados para: "${texto}"`);
      }

      // Renderizar resultados
      window.renderResultados = function (libros, titulo) {
        const contenedor = document.getElementById("resultadosContainer");
        const tituloHTML = document.getElementById("tituloBusqueda");

        tituloHTML.textContent = titulo;
        contenedor.innerHTML = "";

        if (libros.length === 0) {
          contenedor.innerHTML = `<p class="text-gray-500 text-center">No se encontraron resultados.</p>`;
          return;
        }

        libros.forEach((libro) => {
          contenedor.innerHTML += `
        <div class="w-60 bg-white shadow rounded-lg p-3">
          <img src="${
            libro.imagen_url
          }" class="w-full h-72 object-cover rounded" />
          <h3 class="font-semibold mt-2">${libro.titulo}</h3>
          <p class="text-sm text-gray-600">${libro.autor}</p>
          <p class="font-bold mt-1">$${libro.precio.toFixed(2)}</p>
          <button 
            class="mt-2 bg-orange-600 text-white w-full py-1 rounded"
            onclick="openDetailModal('${libro.id}')"
          >Detalles</button>
        </div>
      `;
        });
      };
    </script>
  </body>
</html>
